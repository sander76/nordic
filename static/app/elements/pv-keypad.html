<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<!-- <link rel="import" href="../bower_components/paper-button/paper-button.html"> -->


<dom-module id="pv-keypad">
    <template>
        <style>
            .button {
                fill: #000000;
                opacity: 0;
            }

            svg {
                max-width: 100%;
                max-height: 100%;
                height:100%;
            }
        </style>
        <iron-ajax id="sendCommand" url="/nordic" method="POST" content-type="application/json"></iron-ajax>
        <div style="height: 100%">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 377.15353 617.03544" height="658.171" width="402.297">
                <g transform="translate(-233.705 -256.274)">
                    <rect width="376.654" height="132.389" x="233.955" y="256.524" rx="3.543" ry="3.543" fill="#646464" stroke="#000" stroke-width=".5" stroke-linecap="round" stroke-linejoin="round" />
                    <rect width="376.654" height="480.67" x="233.955" y="392.39" rx="3.543" ry="3.543" fill="#646464" stroke="#000" stroke-width=".5" stroke-linecap="round" stroke-linejoin="round" />
                    <path fill="#464646" stroke="#000" stroke-width=".5" stroke-linecap="round" stroke-linejoin="round" d="M236.508 388.911h371.547v3.543H236.508z" />
                    <rect width="282.965" height="419.382" x="280.799" y="408.24" rx="10.63" ry="10.63" fill="#464646" stroke="#000" stroke-width=".5" stroke-linecap="round" stroke-linejoin="round" />
                    <g transform="translate(305.09 3.845)">
                        <rect rx="7.087" ry="7.087" y="414.568" x="54.698" height="59.436" width="124.987" fill="#fff" stroke="#333" stroke-width=".8" />
                        <path d="M73.403 467.317l43.789-46.063 43.788 46.063z" fill="#1a1a1a" />
                    </g>
                    <g transform="translate(-197.493 132.572)">
                        <rect width="59.436" height="124.987" x="691.04" y="355.38" ry="7.087" rx="7.087" fill="#fff" stroke="#333" stroke-width=".8" />
                        <path d="M717.163 471.264s18.589-32.437 11.395-80.253l8.676-2.7-29.355-23.827-1.799 34.844 10.342-3.573c6.967 42.935-12.14 69.888-12.14 69.888l12.881 5.621z" fill="#1a1a1a" />
                    </g>
                    <g transform="translate(343.273 44.98)">
                        <rect width="124.987" height="59.436" x="16.514" y="577.855" ry="7.087" rx="7.087" fill="#fff" stroke="#333" stroke-width=".8" />
                        <path d="M122.797 584.541l-43.789 46.063-43.788-46.063z" fill="#1a1a1a" />
                    </g>
                    <g transform="translate(-564.924 20.904)">
                        <rect rx="7.087" ry="7.087" y="467.049" x="856.503" height="124.987" width="59.436" fill="#fff" stroke="#333" stroke-width=".8" />
                        <path d="M889.816 476.152s-18.589 32.438-11.395 80.253l-8.676 2.7 29.356 23.828 1.798-34.845-10.342 3.574c-6.967-42.936 12.14-69.888 12.14-69.888l-12.881-5.622z" fill="#1a1a1a" />
                    </g>
                    <g transform="matrix(1.07628 0 0 1.07628 223.677 323.667)">
                        <rect rx="6.584" ry="6.584" y="342.66" x="63.09" height="116.129" width="116.129" fill="#fff" stroke="#333" stroke-width=".743" />
                        <path d="M169.854 430.823l-30.098-30.098 30.098-30.098a3.1 3.1 0 0 0 .71-1.107 3.095 3.095 0 0 0-.71-3.277l-14.218-14.218a3.102 3.102 0 0 0-3.277-.71 3.092 3.092 0 0 0-1.107.707l-30.098 30.098-30.097-30.098a3.092 3.092 0 0 0-1.107-.707 3.095 3.095 0 0 0-3.277.71l-14.218 14.218a3.102 3.102 0 0 0 0 4.384l30.098 30.098-30.098 30.098a3.143 3.143 0 0 0-.71 1.106 3.096 3.096 0 0 0 .71 3.277l14.218 14.219a3.102 3.102 0 0 0 4.384 0l30.098-30.098 30.097 30.098a3.1 3.1 0 0 0 1.107.71 3.095 3.095 0 0 0 3.277-.71l14.218-14.219a3.096 3.096 0 0 0 .71-3.277 3.1 3.1 0 0 0-.71-1.106z"
                            fill="red" />
                    </g>
                    <g transform="matrix(1.07628 0 0 1.07628 219.888 323.056)">
                        <rect width="116.129" height="116.129" x="193.359" y="342.66" ry="6.584" rx="6.584" fill="#fff" stroke="#333" stroke-width=".743" />
                        <path d="M285.528 361.97l-46.506 46.506-21.703-21.703-15.502 15.502 37.205 37.205 62.008-62.008z" fill="#0f0" />
                    </g>
                    <rect rx="7.087" ry="7.087" y="622.835" x="291.579" height="59.436" width="59.436" fill="#646464" stroke="#333" stroke-width=".8" />
                    <g transform="translate(-352.36 -254.981)">
                        <rect rx="7.087" ry="7.087" y="742.934" x="712.148" height="124.987" width="124.987" fill="#fff" stroke="#333" stroke-width=".8" />
                        <path d="M740.98 771.766h67.323v67.323H740.98z" />
                    </g>
                    <rect rx="7.087" ry="7.087" y="418.412" x="291.579" height="59.436" width="59.436" fill="#646464" stroke="#333" stroke-width=".8" />
                    <rect rx="7.087" ry="7.087" y="622.835" x="493.548" height="59.436" width="59.436" fill="#646464" stroke="#333" stroke-width=".8" />
                    <rect rx="7.087" ry="7.087" y="418.412" x="493.548" height="59.436" width="59.436" fill="#646464" stroke="#333" stroke-width=".8" />
                </g>
                <rect id="close" class="button" width="124.987" height="59.436" x="126.083" y="366.561" ry="7.087" rx="7.087" stroke="#333" stroke-width=".8" />
                <rect id="tiltup" class="button" width="59.436" height="124.987" x="259.843" y="231.678" opacity="1" ry="7.087" rx="7.087" stroke="#333" stroke-width=".8" />
                <rect id="cancel" class="button" width="124.987" height="124.987" x="57.874" y="436.191" ry="7.087" rx="7.087" stroke="#333" stroke-width=".8" />
                <rect id="open" class="button" width="124.987" height="59.436" x="126.083" y="162.138" ry="7.087" rx="7.087" stroke="#333" stroke-width=".8" />
                <rect id="tiltdown" class="button" width="59.436" height="124.987" x="57.874" y="231.678" ry="7.087" rx="7.087" stroke="#333" stroke-width=".8" />
                <rect id="okay" class="button" width="124.987" height="124.987" x="194.292" y="435.58" ry="7.087" rx="7.087" stroke="#333" stroke-width=".8" />
                <rect id="stop" class="button" width="124.987" height="124.987" x="126.083" y="231.678" ry="7.087" rx="7.087" stroke="#333" stroke-width=".8" />
            </svg>

        </div>
    </template>
    <script>
        Polymer({
            is: 'pv-keypad',
            properties: {
                active: {
                    type: Boolean,
                    observer: '_activeChanged'
                },
                target: {
                    type: Object,
                    value: function() {
                        return document.body;
                    }
                },
                data: {
                    type: Object,
                    value: {},
                    observer: '_dataChanged'
                }

            },
            ready: function() {
                this.keys = {
                    w: {
                        function: "open",
                        handle: this.handleOpen
                    },
                    z: {
                        function: "close",
                        handle: this.handleClose
                    },
                    s: {
                        function: "stop",
                        handle: this.handleStop
                    },
                    d: {
                        function: "tiltup",
                        handle: this.handleTiltup
                    },
                    a: {
                        function: "tiltdown",
                        handle: this.handleTiltdown
                    },
                    Enter: {
                        function: "okay",
                        handle: this.handleOkay
                    },
                    x: {
                        function: "cancel",
                        handle: this.handleCancel
                    }
                };
                // When the key is not in the active_buttons array the handler
                // should turn to empty.
                this._dataChanged();


            },
            _dataChanged: function(newValue, oldValue) {
                for (var key in this.keys) {
                    if (this.keys.hasOwnProperty(key)) {
                        this.keys[key].confirm = this.handleEmptyConfirm;
                        var idx = this.data.active_buttons.indexOf(this.keys[key].function);
                        if (idx > -1) {
                            if (this.keys[key].function === this.data.confirm) {
                                this.keys[key].confirm = this.handleConfirm;
                            }
                        } else {
                            this.keys[key].handle = this.empty(key);

                            //this.$[this.keys[key].function].className="disabled";
                            var cls = this.$[this.keys[key].function];
                            cls.style.opacity = 0.6;

                        }
                        //check whether confirm dialog button should be added.

                    }
                }
            },
            handleEmptyConfirm: function() {
                console.log("not a confirm button");
            },
            empty: function(key) {
                return function() {
                    console.log("disabled this button: ", key);
                };
            },

            keylookup: function(e) {
                var code = this.keys[e.key] || {
                    handle: function() {
                        return;
                    }
                };
                code.handle.call(this);
                code.confirm.call(this);
            },
            handleConfirm: function(e) {
                this.fire('openmodal');
            },
            handleEvent: function(event) {
                switch (event.type) {
                    case "keydown":
                        this.keylookup(event);
                        break;
                    case "mousedown":
                        switch (event.currentTarget.id) {
                            case "tiltup":
                                this.keylookup({
                                    key: 'd'
                                });
                                break;
                            case "tiltdown":
                                this.keylookup({
                                    key: "a"
                                });
                                break;
                            case "open":
                                this.keylookup({
                                    key: "w"
                                });
                                break;
                            case "close":
                                this.keylookup({
                                    key: "z"
                                });
                                break;
                            case "stop":
                                this.keylookup({
                                    key: "s"
                                });
                                break;
                            case "okay":
                                this.keylookup({
                                    key: "Enter"
                                });
                                break;
                            case "cancel":
                                this.keylookup({
                                    key: "x"
                                });
                                break;
                        }
                        break;
                }
            },
            _activeChanged: function(_new, _old) {
                //this.active = _new;
                if (_new) {
                    //document.addEventListener("keydown",function(e){this.keylookup(e);});
                    document.body.addEventListener("keydown", this, false);
                    //this.listen(this.$.tiltupbutton,'')
                    this.$.tiltup.addEventListener("mousedown", this, false);
                    this.$.tiltdown.addEventListener("mousedown", this, false);
                    this.$.open.addEventListener("mousedown", this, false);
                    this.$.close.addEventListener("mousedown", this, false);
                    this.$.stop.addEventListener("mousedown", this, false);
                    this.$.okay.addEventListener("mousedown", this, false);
                    this.$.cancel.addEventListener("mousedown", this, false);
                } else {
                    document.body.removeEventListener("keydown", this, false);
                    this.$.tiltup.removeEventListener("mousedown", this, false);
                    this.$.tiltdown.removeEventListener("mousedown", this, false);
                    this.$.open.removeEventListener("mousedown", this, false);
                    this.$.close.removeEventListener("mousedown", this, false);
                    this.$.stop.removeEventListener("mousedown", this, false);
                    this.$.okay.removeEventListener("mousedown", this, false);
                    this.$.cancel.removeEventListener("mousedown", this, false);
                }
            },

            handleOpen: function(e) {
                // if (this.active) {
                this.send(["open"]);
                //console.log("open");
                // }
            },
            handleClose: function(e) {
                // if (this.active) {
                this.send(["close"]);
                //console.log("close");
                //}
            },
            handleTiltup: function(e) {
                // if (this.active) {
                this.send(["tiltopen"]);
                //console.log("tilt open");
                //}
            },
            handleTiltdown: function(e) {
                //if (this.active) {
                this.send(["tiltclose"]);
                //console.log("tiltclose");
                //}
            },
            handleStop: function(e) {
                //if (this.active) {
                this.send(["stop"]);
                //console.log("stop");
                //}
            },
            handleOkay: function(e) {
                var okay = this.data.okay;
                if (this.data.okay !== undefined) {
                    var cmd = this.data.okay.commands || undefined;
                    if (cmd !== undefined) {
                        this.send(cmd);
                    }
                    var goto = this.data.okay.goto || undefined;
                    if (goto !== undefined) {
                        this.fire("gotopage", goto);
                    }
                }
            },
            handleCancel: function(e) {
                this.fire("gotopage", this.data.cancel);
            },

            send: function(commands) {
                //populate the body of the request.
                this.$.sendCommand.body = {
                    "commands": commands
                };
                this.$.sendCommand.generateRequest();
                //console.log("command sent: " + commands.command);
                this.command_logger(commands);

            },
            command_logger: function(commands) {
                var first = true;
                for (var i = 0; i < commands.length; i += 1) {
                    if (first) {
                        console.log("Sending commands to nordic:");
                        console.log(commands[i]);
                        first = false;
                    } else {
                        console.log(commands[i].command);
                    }
                }
            }
        });
    </script>
    </dom-element>
